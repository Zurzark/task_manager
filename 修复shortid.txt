(function fixDuplicateShortIds() {
    console.log("ðŸš€ å¼€å§‹ä¿®å¤ ShortID...");

    // 1. è¯»å–æ•°æ®
    const tasksRaw = localStorage.getItem('tasks_v3');
    const configRaw = localStorage.getItem('config_v3');

    if (!tasksRaw) {
        console.error("âŒ æœªæ‰¾åˆ°ä»»åŠ¡æ•°æ® (tasks_v3)");
        return;
    }

    let tasks = JSON.parse(tasksRaw);
    let config = configRaw ? JSON.parse(configRaw) : { nextShortId: 1 };

    // 2. æŒ‰åˆ›å»ºæ—¶é—´æŽ’åº (ç¡®ä¿ ID å¢žé•¿ç¬¦åˆæ—¶é—´é€»è¾‘)
    tasks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    // 3. é‡æ–°åˆ†é… ID å¹¶å»ºç«‹æ˜ å°„è¡¨
    const uuidToNewShortIdMap = new Map();
    let counter = 1;

    console.log(`ðŸ“‹ æ­£åœ¨é‡ç½® ${tasks.length} ä¸ªä»»åŠ¡çš„ ID...`);

    tasks.forEach(task => {
        const oldId = task.shortId;
        const newId = counter++;
        
        task.shortId = newId;
        uuidToNewShortIdMap.set(task.id, newId); // è®°å½• UUID -> æ–° ShortID çš„å…³ç³»
    });

    // 4. ä¿®å¤å…³è”å…³ç³» (Relations)
    // çˆ¶å­å…³ç³»é€šå¸¸é€šè¿‡ parentId (UUID) ç»‘å®šï¼Œä¸å— shortId å½±å“ï¼Œæ— éœ€ä¿®å¤
    // ä½† relations æ•°ç»„ä¸­æ˜¾å¼å­˜å‚¨äº† targetShortIdï¼Œå¿…é¡»ä¿®å¤
    let relationFixCount = 0;

    tasks.forEach(task => {
        if (task.relations && Array.isArray(task.relations)) {
            task.relations.forEach(rel => {
                // å¦‚æžœæœ‰å…³è”ç›®æ ‡ UUID
                if (rel.targetId) {
                    const newTargetShortId = uuidToNewShortIdMap.get(rel.targetId);
                    // å¦‚æžœæ‰¾åˆ°äº†æ–°çš„ IDï¼Œä¸”ä¸Žæ—§çš„ä¸ä¸€è‡´ï¼Œåˆ™æ›´æ–°
                    if (newTargetShortId && rel.targetShortId !== newTargetShortId) {
                        rel.targetShortId = newTargetShortId;
                        relationFixCount++;
                    }
                }
            });
        }
    });

    console.log(`ðŸ”— ä¿®å¤äº† ${relationFixCount} ä¸ªå…³è”å…³ç³»çš„å¼•ç”¨ ID`);

    // 5. æ›´æ–°é…ç½®ä¸­çš„ nextShortId
    config.nextShortId = counter;
    console.log(`ðŸ”¢ ä¸‹ä¸€ä¸ªå¯ç”¨ ID é‡ç½®ä¸º: ${counter}`);

    // 6. ä¿å­˜å›ž LocalStorage
    localStorage.setItem('tasks_v3', JSON.stringify(tasks));
    localStorage.setItem('config_v3', JSON.stringify(config));

    console.log("âœ… ä¿®å¤å®Œæˆï¼é¡µé¢å³å°†åˆ·æ–°...");
    
    // 7. è‡ªåŠ¨åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ›´æ”¹
    setTimeout(() => {
        window.location.reload();
    }, 1000);

})();